<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agregar Prueba</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <h1>Agregar Nueva Prueba</h1>
    <form id="agregarPruebaForm" action="/api/pruebas" method="POST">
      <label for="proyecto">Proyecto:</label>
      <input
        type="text"
        id="proyecto"
        name="proyecto"
        placeholder="Nombre del proyecto"
        required
      />
      <br />

      <label for="fechaPrueba">Fecha de la prueba:</label>
      <input type="date" id="fechaPrueba" name="fechaPrueba" required />
      <br />

      <label for="equipoPruebas">Equipo de Pruebas:</label>
      <div id="equipoPruebasContainer">
        <input
          type="text"
          name="equipoPruebas[]"
          placeholder="Nombre del miembro del equipo"
          required
        />
      </div>
      <button type="button" onclick="agregarCampoEquipo()">
        Agregar Miembro
      </button>
      <br />

      <label for="requisitosProbados">Requisitos Probados:</label>
      <textarea
        id="requisitosProbados"
        name="requisitosProbados"
        placeholder="Lista de requisitos, separados por comas"
      ></textarea>
      <br />

      <label for="configuracionPrueba">Configuración de Prueba:</label>
      <div id="configuracionPruebaContainer">
        <div class="claveValor">
          <input
            type="text"
            name="configuracionPruebaKey[]"
            placeholder="Configuracion"
            required
          />
          <input
            type="text"
            name="configuracionPruebaValue[]"
            placeholder="Detalles"
            required
          />
        </div>
      </div>
      <button type="button" onclick="agregarCampoConfiguracion()">
        Agregar
      </button>
      <br />

      <label for="pasosPrueba">Pasos de Prueba:</label>
      <textarea
        id="pasosPrueba"
        name="pasosPrueba"
        placeholder="Lista de pasos, separados por comas"
      ></textarea>
      <br />

      <label for="resultadosEsperados">Resultados Esperados:</label>
      <div id="resultadosEsperadosContainer">
        <div class="claveValor">
          <input
            type="text"
            name="resultadosEsperadosKey[]"
            placeholder="Funcionalidad"
            required
          />
          <input
            type="text"
            name="resultadosEsperadosValue[]"
            placeholder="Detalles"
            required
          />
        </div>
      </div>
      <button type="button" onclick="agregarCampoResultadosEsperados()">
        Agregar
      </button>
      <br />

      <label for="resultadosObtenidos">Resultados Obtenidos:</label>
      <div id="resultadosObtenidosContainer">
        <div class="claveValor">
          <input
            type="text"
            name="resultadosObtenidosKey[]"
            placeholder="Funcionalidad"
            required
          />
          <input
            type="text"
            name="resultadosObtenidosValue[]"
            placeholder="Detalles"
            required
          />
        </div>
      </div>
      <button type="button" onclick="agregarCampoResultadosObtenidos()">
        Agregar
      </button>
      <br />

      <label for="conclusiones">Conclusiones:</label>
      <div id="conclusionesContainer">
        <div class="claveValor">
          <input
            type="text"
            name="conclusionesKey[]"
            placeholder="Conclucion"
            required
          />
          <input
            type="text"
            name="conclusionesValue[]"
            placeholder="Detalles"
            required
          />
        </div>
      </div>
      <button type="button" onclick="agregarCampoConclusiones()">
        Agregar
      </button>
      <br />

      <label for="observaciones">Observaciones:</label>
      <div id="observacionesContainer">
        <input
          type="text"
          name="observaciones[]"
          placeholder="Observación"
          required
        />
      </div>
      <button type="button" onclick="agregarCampoObservaciones()">
        Agregar Observación
      </button>
      <br />

      <button type="submit">Agregar Prueba</button>
    </form>

    <script>
      // Agregar campos dinámicos para el equipo de pruebas y observaciones
      function agregarCampoEquipo() {
        const container = document.getElementById("equipoPruebasContainer");
        const input = document.createElement("input");
        input.type = "text";
        input.name = "equipoPruebas[]";
        input.placeholder = "Nombre del miembro del equipo";
        container.appendChild(input);
      }

      function agregarCampoObservaciones() {
        const container = document.getElementById("observacionesContainer");
        const input = document.createElement("input");
        input.type = "text";
        input.name = "observaciones[]";
        input.placeholder = "Observación";
        container.appendChild(input);
      }

      function agregarCampoConfiguracion() {
        const container = document.getElementById(
          "configuracionPruebaContainer"
        );

        const div = document.createElement("div");
        div.classList.add("claveValor");

        const inputKey = document.createElement("input");
        inputKey.type = "text";
        inputKey.name = "configuracionPruebaKey[]";
        inputKey.placeholder = "Clave (ej. sistemaOperativo)";
        inputKey.required = true;

        const inputValue = document.createElement("input");
        inputValue.type = "text";
        inputValue.name = "configuracionPruebaValue[]";
        inputValue.placeholder = "Valor (ej. Windows 10)";
        inputValue.required = true;

        div.appendChild(inputKey);
        div.appendChild(inputValue);
        container.appendChild(div);
      }

      function agregarCampoResultadosEsperados() {
        const container = document.getElementById(
          "resultadosEsperadosContainer"
        );

        const div = document.createElement("div");
        div.classList.add("claveValor");

        const inputKey = document.createElement("input");
        inputKey.type = "text";
        inputKey.name = "resultadosEsperadosKey[]";
        inputKey.placeholder = "Clave (ej. funcionalidad)";
        inputKey.required = true;

        const inputValue = document.createElement("input");
        inputValue.type = "text";
        inputValue.name = "resultadosEsperadosValue[]";
        inputValue.placeholder = "Valor (ej. debe funcionar correctamente)";
        inputValue.required = true;

        div.appendChild(inputKey);
        div.appendChild(inputValue);
        container.appendChild(div);
      }

      function agregarCampoResultadosObtenidos() {
        const container = document.getElementById(
          "resultadosObtenidosContainer"
        );

        const div = document.createElement("div");
        div.classList.add("claveValor");

        const inputKey = document.createElement("input");
        inputKey.type = "text";
        inputKey.name = "resultadosObtenidosKey[]";
        inputKey.placeholder = "Clave (ej. funcionalidad)";
        inputKey.required = true;

        const inputValue = document.createElement("input");
        inputValue.type = "text";
        inputValue.name = "resultadosObtenidosValue[]";
        inputValue.placeholder = "Valor (ej. funcionó correctamente)";
        inputValue.required = true;

        div.appendChild(inputKey);
        div.appendChild(inputValue);
        container.appendChild(div);
      }

      function agregarCampoConclusiones() {
        const container = document.getElementById("conclusionesContainer");

        const div = document.createElement("div");
        div.classList.add("claveValor");

        const inputKey = document.createElement("input");
        inputKey.type = "text";
        inputKey.name = "conclusionesKey[]";
        inputKey.placeholder = "Clave (ej. recomendación)";
        inputKey.required = true;

        const inputValue = document.createElement("input");
        inputValue.type = "text";
        inputValue.name = "conclusionesValue[]";
        inputValue.placeholder = "Valor (ej. mejorar desempeño)";
        inputValue.required = true;

        div.appendChild(inputKey);
        div.appendChild(inputValue);
        container.appendChild(div);
      }

      document
        .getElementById("agregarPruebaForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const configuracionPruebaKeys = Array.from(
            document.querySelectorAll('[name="configuracionPruebaKey[]"]')
          ).map((input) => input.value);
          const configuracionPruebaValues = Array.from(
            document.querySelectorAll('[name="configuracionPruebaValue[]"]')
          ).map((input) => input.value);
          const configuracionPrueba = {};
          configuracionPruebaKeys.forEach((key, index) => {
            configuracionPrueba[key] = configuracionPruebaValues[index];
          });

          const resultadosEsperadosKeys = Array.from(
            document.querySelectorAll('[name="resultadosEsperadosKey[]"]')
          ).map((input) => input.value);
          const resultadosEsperadosValues = Array.from(
            document.querySelectorAll('[name="resultadosEsperadosValue[]"]')
          ).map((input) => input.value);

          const resultadosObtenidosKeys = Array.from(
            document.querySelectorAll('[name="resultadosObtenidosKey[]"]')
          ).map((input) => input.value);
          const resultadosObtenidosValues = Array.from(
            document.querySelectorAll('[name="resultadosObtenidosValue[]"]')
          ).map((input) => input.value);

          const conclusionesKeys = Array.from(
            document.querySelectorAll('[name="conclusionesKey[]"]')
          ).map((input) => input.value);
          const conclusionesValues = Array.from(
            document.querySelectorAll('[name="conclusionesValue[]"]')
          ).map((input) => input.value);

          const resultadosEsperados = {};
          resultadosEsperadosKeys.forEach((key, index) => {
            resultadosEsperados[key] = resultadosEsperadosValues[index];
          });

          const resultadosObtenidos = {};
          resultadosObtenidosKeys.forEach((key, index) => {
            resultadosObtenidos[key] = resultadosObtenidosValues[index];
          });

          const conclusiones = {};
          conclusionesKeys.forEach((key, index) => {
            conclusiones[key] = conclusionesValues[index];
          });

          const equipoPruebas = Array.from(
            document.querySelectorAll('[name="equipoPruebas[]"]')
          ).map((input) => input.value);
          const observaciones = Array.from(
            document.querySelectorAll('[name="observaciones[]"]')
          ).map((input) => input.value);

          const nuevaPrueba = {
            proyecto: document.getElementById("proyecto").value,
            fechaPrueba: document.getElementById("fechaPrueba").value,
            equipoPruebas: Array.from(
              document.querySelectorAll('[name="equipoPruebas[]"]')
            ).map((input) => input.value),
            requisitosProbados: document
              .getElementById("requisitosProbados")
              .value.split(",")
              .map((item) => item.trim()),
            configuracionPrueba: configuracionPrueba,
            pasosPrueba: document
              .getElementById("pasosPrueba")
              .value.split(",")
              .map((item) => item.trim()),
            resultadosEsperados: resultadosEsperados,
            resultadosObtenidos: resultadosObtenidos,
            conclusiones: conclusiones,
            observaciones: Array.from(
              document.querySelectorAll('[name="observaciones[]"]')
            ).map((input) => input.value),
          };

          // Enviar los datos al servidor
          fetch("http://localhost:3000/api/pruebas", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(nuevaPrueba),
          })
            .then((response) => response.json())
            .then((data) => {
              alert("Prueba agregada exitosamente");
              window.location.href = "index.html"; // Redirigir a la página principal
            })
            .catch((error) => {
              alert("Error al agregar la prueba");
              console.error(error);
            });
        });

      // Función para convertir texto en un objeto JSON
      function createJSONFromText(text) {
        const lines = text
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0);
        const result = {};
        lines.forEach((line, index) => {
          result[`item_${index + 1}`] = line; // Asignar claves dinámicas
        });
        return result;
      }
    </script>
  </body>
</html>
